name: Lint

# **What it does**: Runs go linter when go files have been modified
# and proto linters when proto files have been modified.
#
# **Why we have it**: Ensures all go files and proto files are
# properly formatted according to lint configuration files.
#
# **What does it impact**: Code quality.

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  golangci:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read  # for technote-space/get-diff-action to get git reference
    strategy:
      matrix:
        module: ["api", "db", "indexer", "monitor", "state"]
    steps:
      - uses: actions/checkout@v3

      # api module

      - uses: technote-space/get-diff-action@v6
        id: git-diff-api
        with:
          PATTERNS: |
            api/**/**.go
            api/go.mod
            api/go.sum
        if: matrix.module == 'api'
      - uses: actions/setup-go@v4
        with:
          go-version-file: api/go.mod
        if: env.GIT_DIFF
      - uses: golangci/golangci-lint-action@v3
        with:
          working-directory: api
        if: steps.git-diff-api.outputs.diff

      # db module

      - uses: technote-space/get-diff-action@v6
        id: git-diff-db
        with:
          PATTERNS: |
            db/**/**.go
            db/go.mod
            db/go.sum
        if: matrix.module == 'db'
      - uses: actions/setup-go@v4
        with:
          go-version-file: db/go.mod
        if: env.GIT_DIFF
      - uses: golangci/golangci-lint-action@v3
        with:
          working-directory: db
        if: steps.git-diff-api.outputs.diff

      # indexer module

      - uses: technote-space/get-diff-action@v6
        id: git-diff-indexer
        with:
          PATTERNS: |
            indexer/**/**.go
            indexer/go.mod
            indexer/go.sum
        if: matrix.module == 'indexer'
      - uses: actions/setup-go@v4
        with:
          go-version-file: indexer/go.mod
        if: env.GIT_DIFF
      - uses: golangci/golangci-lint-action@v3
        with:
          working-directory: indexer
        if: steps.git-diff-api.outputs.diff

      # monitor module

      - uses: technote-space/get-diff-action@v6
        id: git-diff-monitor
        with:
          PATTERNS: |
            monitor/**/**.go
            monitor/go.mod
            monitor/go.sum
        if: matrix.module == 'monitor'
      - uses: actions/setup-go@v4
        with:
          go-version-file: monitor/go.mod
        if: env.GIT_DIFF
      - uses: golangci/golangci-lint-action@v3
        with:
          working-directory: monitor
        if: steps.git-diff-api.outputs.diff

      # state module

      - uses: technote-space/get-diff-action@v6
        id: git-diff-state
        with:
          PATTERNS: |
            state/**/**.go
            state/go.mod
            state/go.sum
        if: matrix.module == 'state'
      - uses: actions/setup-go@v4
        with:
          go-version-file: state/go.mod
        if: env.GIT_DIFF
      - uses: golangci/golangci-lint-action@v3
        with:
          working-directory: state
        if: steps.git-diff-api.outputs.diff
